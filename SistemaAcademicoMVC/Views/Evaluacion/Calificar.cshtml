@model SistemaAcademicoMVC.Models.Evaluacion

@{
    ViewBag.Title = "Calificar estudiante";
    var estudiante = ViewBag.Estudiante;
    var curso = ViewBag.Curso;
}

<h2>Calificar estudiante</h2>

@if (estudiante != null)
{
    <p><strong>Estudiante:</strong> @estudiante.Nombre @estudiante.Apellidos</p>
}
@if (curso != null)
{
    <p><strong>Curso:</strong> @curso.Nombre (@curso.Codigo)</p>
}

<div id="msgEstado" style="display:none; position:absolute; top:20px; right:30px; z-index:9999; min-width:250px; max-width:350px;"></div>

@using (Html.BeginForm("Calificar", "Evaluacion", FormMethod.Post, new { id = "calificarForm", autocomplete = "off" }))
{
    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.MatriculaId)

    <div class="form-group">
        @Html.LabelFor(m => m.NotaNumerica)
        @Html.TextBoxFor(m => m.NotaNumerica, new { @class = "form-control", type = "number", min = "0", max = "100", required = "required" })
        @Html.ValidationMessageFor(m => m.NotaNumerica)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.Observaciones)
        @Html.TextAreaFor(m => m.Observaciones, new { @class = "form-control", required = "required" })
        @Html.ValidationMessageFor(m => m.Observaciones)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.TipoParticipacion)
        @Html.TextBoxFor(m => m.TipoParticipacion, new { @class = "form-control", required = "required" })
        @Html.ValidationMessageFor(m => m.TipoParticipacion)
    </div>

    <div class="form-group">
        @Html.LabelFor(m => m.Estado)
        @Html.DropDownListFor(m => m.Estado, new SelectList(new[] { "Aprobado", "Reprobado" }), "Seleccione", new { @class = "form-control", required = "required" })
        @Html.ValidationMessageFor(m => m.Estado)
    </div>

    <button type="submit" class="btn btn-primary">Guardar calificación</button>
}



@section scripts {
    <script>
        $('#calificarForm').submit(function (e) {
            e.preventDefault();
            var form = $(this);

            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function (response) {
                    if (response.success) {
                        $('#msgEstado').html('<div class="alert alert-success">' + response.mensaje + '</div>').show();
                        setTimeout(function () { $('#msgEstado').fadeOut(); }, 4000);
                    } else {
                        $('#msgEstado').html(""); // limpiar
                        $.each(response.errores, function (i, error) {
                            $('#msgEstado').append(
                                '<div class="alert alert-danger">Error en "' + error.Campo + '": ' + error.Mensaje + '</div>'
                            );
                        });
                        $('#msgEstado').show();
                        setTimeout(function () { $('#msgEstado').fadeOut(); }, 4000);
                    }
                },
                error: function () {
                    $('#msgEstado').html('<div class="alert alert-danger">Ocurrió un error inesperado.</div>').show();
                    setTimeout(function () { $('#msgEstado').fadeOut(); }, 4000);
                }
            });
        });
        if (response.success) {
            window.location.href = '/Estudiantes/Index'; // Redirige al listado
        }
    </script>
}